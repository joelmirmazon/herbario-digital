<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbário Virtual ARAUCA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        arauca: { 50: '#f2f7f5', 100: '#e6efeb', 500: '#5c8d75', 600: '#4a7560', 700: '#3d614f', 800: '#324e41', 900: '#2a4036' },
                        flower: { 500: '#db2777', 100: '#fce7f3' }, 
                        fruit: { 500: '#f97316', 100: '#ffedd5' }
                    },
                    fontFamily: { serif: ['Merriweather', 'serif'], sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scientific-name { font-family: 'Merriweather', serif; font-style: italic; }
        
        /* Estilos Reflora / Científicos */
        .reflora-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #3d614f; margin-bottom: 0.25rem; letter-spacing: 0.05em; border-left: 3px solid #5c8d75; padding-left: 0.5rem; margin-top: 1rem; }
        .reflora-text { font-size: 0.9rem; line-height: 1.6; color: #374151; text-align: justify; }
        
        /* Checkbox da Chave */
        .key-checkbox:checked + div { background-color: #4a7560; color: white; border-color: #4a7560; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #5c8d75; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-arauca-900 text-white shadow-xl sticky top-0 z-40 border-b-4 border-arauca-500">
        <div class="max-w-7xl mx-auto px-4 h-16 md:h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-white/5 p-2 rounded-lg border border-white/10 hidden md:block">
                    <i class="ph ph-tree-evergreen text-3xl text-arauca-500"></i>
                </div>
                <div>
                    <h1 class="text-lg md:text-2xl font-serif font-bold tracking-wide leading-none">ARAUCA</h1>
                    <p class="text-[10px] md:text-xs text-arauca-100 uppercase tracking-widest mt-1 opacity-80">Herbário Virtual do Centro-Sul do Paraná</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <nav class="flex bg-arauca-800/50 p-1 rounded-lg">
                    <button onclick="switchTab('collection')" id="tab-collection" class="px-4 py-1.5 rounded text-xs md:text-sm font-semibold transition bg-arauca-600 shadow text-white flex items-center gap-2">
                        <i class="ph ph-books"></i> Acervo
                    </button>
                    <button onclick="switchTab('key')" id="tab-key" class="px-4 py-1.5 rounded text-xs md:text-sm font-semibold transition text-arauca-200 hover:text-white hover:bg-arauca-800 flex items-center gap-2">
                        <i class="ph ph-key"></i> Chave ID
                    </button>
                </nav>
                <button onclick="openAdmin()" class="p-2 text-arauca-300 hover:text-white hover:bg-white/10 rounded-full transition" title="Acesso Administrativo">
                    <i class="ph ph-lock-key"></i>
                </button>
            </div>
        </div>
    </header>

    <main id="view-collection" class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full animate-fade-in">
        <div class="flex justify-between items-end mb-6 border-b border-gray-200 pb-4">
            <div>
                <h2 class="text-xl font-bold text-arauca-900 flex items-center gap-2"><i class="ph ph-magnifying-glass"></i> Explorar Coleção</h2>
                <p class="text-xs text-gray-500 mt-1">Acervo digitalizado com vouchers e geolocalização.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="downloadData()" class="px-3 py-1.5 bg-white border border-gray-200 text-gray-600 rounded text-xs font-bold hover:bg-gray-50 transition"><i class="ph ph-download-simple"></i> Backup</button>
                <label class="px-3 py-1.5 bg-white border border-gray-200 text-gray-600 rounded text-xs font-bold hover:bg-gray-50 transition cursor-pointer">
                    <i class="ph ph-upload-simple"></i> Restaurar
                    <input type="file" onchange="uploadData(this)" class="hidden" accept=".json">
                </label>
            </div>
        </div>

        <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>

    <main id="view-key" class="hidden flex-grow max-w-7xl mx-auto px-4 py-8 w-full">
        <div class="flex flex-col lg:flex-row gap-6">
            <div class="w-full lg:w-1/4">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 sticky top-24">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wider"><i class="ph ph-sliders"></i> Caracteres</h3>
                        <button onclick="resetKey()" class="text-xs text-red-500 hover:underline">Limpar</button>
                    </div>
                    
                    <div id="keyFilters" class="space-y-6">
                        <div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Hábito</h4>
                            <div class="space-y-1">
                                <label class="block cursor-pointer"><input type="checkbox" class="key-checkbox hidden" onchange="filterKey('habito', 'arbusto')"><div class="border border-gray-200 rounded px-3 py-2 hover:bg-gray-50 transition text-sm">Arbusto</div></label>
                                <label class="block cursor-pointer"><input type="checkbox" class="key-checkbox hidden" onchange="filterKey('habito', 'arvore')"><div class="border border-gray-200 rounded px-3 py-2 hover:bg-gray-50 transition text-sm">Árvore</div></label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Fruto</h4>
                            <div class="space-y-1">
                                <label class="block cursor-pointer"><input type="checkbox" class="key-checkbox hidden" onchange="filterKey('fruto', 'baga')"><div class="border border-gray-200 rounded px-3 py-2 hover:bg-gray-50 transition text-sm flex justify-between">Baga <span class="text-[10px] text-gray-400 self-center">Carnoso</span></div></label>
                                <label class="block cursor-pointer"><input type="checkbox" class="key-checkbox hidden" onchange="filterKey('fruto', 'capsula')"><div class="border border-gray-200 rounded px-3 py-2 hover:bg-gray-50 transition text-sm flex justify-between">Cápsula <span class="text-[10px] text-gray-400 self-center">Seco</span></div></label>
                            </div>
                        </div>
                         <div>
                            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Androceu</h4>
                            <div class="space-y-1">
                                <label class="block cursor-pointer"><input type="checkbox" class="key-checkbox hidden" onchange="filterKey('anteras', 'rostradas')"><div class="border border-gray-200 rounded px-3 py-2 hover:bg-gray-50 transition text-sm">Anteras Rostradas</div></label>
                                <label class="block cursor-pointer"><input type="checkbox" class="key-checkbox hidden" onchange="filterKey('anteras', 'amarelas')"><div class="border border-gray-200 rounded px-3 py-2 hover:bg-gray-50 transition text-sm">Anteras Amarelas</div></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-3/4">
                <div class="bg-arauca-50 border border-arauca-100 rounded p-3 mb-4 flex justify-between items-center">
                    <span class="text-sm font-medium text-arauca-800">Gêneros Possíveis</span>
                    <span id="keyCount" class="bg-arauca-600 text-white px-2 py-0.5 rounded text-xs font-bold">0</span>
                </div>
                <div id="keyResults" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </main>

    <div id="detailsModal" class="fixed inset-0 bg-arauca-900/95 backdrop-blur-sm z-50 hidden overflow-y-auto">
        <div class="min-h-screen p-4 flex justify-center items-start pt-10">
            <div class="bg-white w-full max-w-6xl rounded-xl shadow-2xl overflow-hidden flex flex-col lg:flex-row relative">
                
                <button onclick="closeDetails()" class="absolute top-4 right-4 z-20 bg-white/20 hover:bg-red-500 text-gray-500 hover:text-white rounded-full p-2 transition"><i class="ph ph-x text-xl"></i></button>

                <div class="w-full lg:w-4/12 bg-gray-50 border-r border-gray-200 p-6 flex flex-col">
                    <div class="flex mb-4 bg-white rounded-lg border border-gray-200 p-1">
                        <button onclick="swapImage('field')" id="btn-field" class="flex-1 py-1.5 text-xs font-bold uppercase rounded bg-arauca-100 text-arauca-700 shadow-sm">Em Vida</button>
                        <button onclick="swapImage('exsiccate')" id="btn-exsiccate" class="flex-1 py-1.5 text-xs font-bold uppercase rounded text-gray-400 hover:bg-gray-50">Exsicata</button>
                    </div>

                    <div class="aspect-[3/4] bg-gray-200 rounded-lg overflow-hidden relative mb-4 shadow-inner border border-gray-200">
                        <img id="modalImage" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/80 p-3 pt-10">
                            <p id="modalImgCaption" class="text-white text-[10px] leading-tight opacity-90"></p>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg relative mt-auto">
                        <i class="ph ph-magnifying-glass absolute top-3 right-3 text-yellow-200 text-4xl"></i>
                        <h4 class="text-yellow-800 font-bold text-xs uppercase mb-2 flex items-center gap-1"><i class="ph ph-eye"></i> Identificação em Campo</h4>
                        <p id="modalLaymanText" class="text-yellow-900 text-sm font-medium leading-relaxed"></p>
                    </div>
                </div>

                <div class="w-full lg:w-8/12 p-8 max-h-[90vh] overflow-y-auto">
                    
                    <div class="flex justify-between items-start border-b border-gray-100 pb-4 mb-6">
                        <div>
                            <span id="modalFamily" class="text-[10px] font-bold text-arauca-600 bg-arauca-50 px-2 py-1 rounded uppercase tracking-wider">Família</span>
                            <h2 id="modalTitle" class="text-3xl font-serif italic font-bold text-gray-900 mt-2">Nome Científico</h2>
                            <p id="modalAuthor" class="text-gray-400 text-xs font-mono mt-1">Autor</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] uppercase text-gray-400 font-bold">Voucher ARAUCA</p>
                            <p id="modalVoucher" class="font-mono text-lg font-bold text-arauca-700">#0000</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="reflora-title">Diagnose Morfológica</h4>
                            <p id="modalDiagnosis" class="reflora-text border-l-2 border-gray-100 pl-3 italic text-gray-600"></p>
                            
                            <h4 class="reflora-title">Descrição Completa</h4>
                            <p id="modalDescription" class="reflora-text text-xs"></p>

                            <h4 class="reflora-title">Ecologia</h4>
                            <p id="modalEcology" class="reflora-text text-xs"></p>

                            <details class="mt-4">
                                <summary class="text-[10px] font-bold text-gray-400 uppercase cursor-pointer hover:text-arauca-600">Ver Taxonomia e Sinônimos</summary>
                                <div class="p-2 bg-gray-50 rounded mt-2 text-xs font-mono text-gray-500">
                                    <p id="modalTaxonomy" class="mb-2"></p>
                                    <ul id="modalSynonyms" class="list-disc list-inside"></ul>
                                </div>
                            </details>
                        </div>

                        <div class="space-y-6">
                            
                            <div class="bg-white border border-gray-100 rounded-lg p-4 shadow-sm">
                                <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Fenologia Comparativa</h4>
                                <div id="phenologyChart"></div>
                                <div class="flex justify-between mt-2 text-[9px] text-gray-400 px-1">
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-flower-500"></div> Lit. Flor</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-arauca-600"></div> Coleta Local</span>
                                </div>
                            </div>

                            <div class="bg-white border border-gray-100 rounded-lg p-1 shadow-sm h-64 flex flex-col">
                                <div id="map" class="flex-grow rounded z-0"></div> <p class="text-[10px] text-center text-gray-400 mt-1">Localização do Voucher Principal</p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="adminModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-lg shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-arauca-800 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold flex items-center gap-2"><i class="ph ph-user-gear"></i> Cadastro de Espécie</h3>
                <button onclick="closeAdmin()"><i class="ph ph-x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <p class="text-sm text-gray-500 mb-4 bg-yellow-50 p-2 rounded border border-yellow-100">
                    <i class="ph ph-warning"></i> Preencha com rigor científico. As coordenadas devem ser decimais (ex: -25.385).
                </p>
                <form id="adminForm" onsubmit="adminSave(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input id="admFamily" class="border p-2 rounded text-sm" placeholder="Família (ex: Melastomataceae)" required>
                        <input id="admVoucher" class="border p-2 rounded text-sm" placeholder="Voucher (ex: ARAUCA 1432)" required>
                    </div>
                    <input id="admName" class="border p-2 rounded text-sm w-full italic" placeholder="Nome Científico Completo" required>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <input id="admLat" class="border p-2 rounded text-sm" placeholder="Latitude (ex: -25.3853)" required>
                        <input id="admLon" class="border p-2 rounded text-sm" placeholder="Longitude (ex: -51.4987)" required>
                    </div>

                    <div class="space-y-2 border p-3 rounded bg-gray-50">
                        <p class="text-xs font-bold uppercase text-gray-500">Imagens (URLs)</p>
                        <input id="admImgField" class="border p-2 rounded text-sm w-full" placeholder="URL Foto Campo">
                        <input id="admImgExsic" class="border p-2 rounded text-sm w-full" placeholder="URL Foto Exsicata">
                    </div>

                    <textarea id="admMorph" class="border p-2 rounded text-sm w-full" rows="3" placeholder="Diagnose Morfológica (Técnica)"></textarea>
                    <textarea id="admLayman" class="border p-2 rounded text-sm w-full" rows="2" placeholder="Identificação Sherlock (Linguagem Acessível)"></textarea>

                    <button type="submit" class="w-full bg-arauca-600 text-white py-3 rounded font-bold hover:bg-arauca-700">Salvar no Banco de Dados</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DADOS AVANÇADOS (ARAUCA V6) ---
        const seedData = [
            {
                id: 1001,
                family: "Melastomataceae",
                genus: "Rhynchanthera",
                scientificName: "Rhynchanthera brachyrhyncha Cham.",
                author: "Cham.",
                voucher: "ARAUCA 1432",
                coords: [-25.38537156455309, -51.49875613980888], // Coordenadas Reais
                images: {
                    field: { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Rhynchanthera_grandiflora.jpg/640px-Rhynchanthera_grandiflora.jpg", caption: "Hábito em Campo (Foto: Ana Versiane)" },
                    exsiccate: { url: "https://reflora.jbrj.gov.br/reflora/Figura/K/000497/K000497678/0.jpg", caption: "Exsicata (Voucher K000497678)" }
                },
                laymanBox: "Arbusto de áreas úmidas inconfundível pelas flores roxas vibrantes com centro amarelo. O detalhe chave são as anteras (parte amarela) alongadas parecendo um bico de pássaro curvado. Ao toque, as folhas são levemente ásperas.",
                description: {
                    diagnosis: "Anteras rostradas, dimórficas. Lâminas foliares cordadas com indumento glandular. 5 estames férteis e 5 estaminódios.",
                    full: "Subarbusto ereto, ramos quadrangulares com tricomas glandulares. Folhas opostas, 5-7 nervuras acródromas. Inflorescência cimosa terminal. Hipanto campanulado.",
                    ecology: "Heliófila, ocorrendo em solos hidromórficos (banhados) e bordas de Matas de Galeria do Terceiro Planalto."
                },
                phenology: {
                    lit_flowering: [0, 1, 10, 11], // Jan, Fev, Nov, Dez (Reflora)
                    local_collection: [3]          // Abril (Nossa coleta ARAUCA)
                },
                taxonomy: {
                    chain: "Angiospermas > Melastomataceae > Rhynchanthera",
                    synonyms: ["Rhynchanthera humilis Cogn.", "Rhynchanthera kleinii Brade"]
                }
            }
        ];

        // Gêneros da Chave
        const generaKey = [
            { genus: "Rhynchanthera", traits: { habito: ["arbusto"], fruto: "capsula", anteras: "rostradas" } },
            { genus: "Miconia", traits: { habito: ["arbusto", "arvore"], fruto: "baga", anteras: "poricidas" } },
            { genus: "Leandra", traits: { habito: ["arbusto"], fruto: "baga", anteras: "poricidas" } } // Simplificado
        ];

        let plants = [];
        let mapInstance = null; // Variável para segurar o mapa Leaflet
        const STORAGE_KEY = 'arauca_v6_db';

        function init() {
            const stored = localStorage.getItem(STORAGE_KEY);
            plants = stored ? JSON.parse(stored) : seedData;
            renderCollection();
        }

        // --- RENDERIZADORES ---
        function renderCollection() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            plants.forEach(p => {
                const img = p.images?.field?.url || 'https://placehold.co/400';
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition group relative";
                card.innerHTML = `
                    <div class="h-56 relative overflow-hidden">
                        <img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700">
                        <div class="absolute top-0 right-0 bg-arauca-600 text-white text-[10px] font-mono px-2 py-1 rounded-bl shadow">
                            ${p.voucher}
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 p-4 pt-10">
                            <span class="text-[9px] font-bold text-arauca-200 uppercase tracking-wider">${p.family}</span>
                            <h3 class="scientific-name text-white text-lg leading-tight">${p.scientificName}</h3>
                        </div>
                    </div>
                    <div class="p-4 bg-white">
                         <div class="bg-yellow-50 p-2 rounded border border-yellow-100 mb-3">
                             <p class="text-xs text-gray-600 line-clamp-3 italic"><i class="ph ph-eye text-yellow-600"></i> "${p.laymanBox}"</p>
                         </div>
                        <button onclick="openDetails(${p.id})" class="w-full py-2 bg-gray-50 border border-gray-200 text-gray-600 text-xs font-bold uppercase rounded hover:bg-arauca-600 hover:text-white hover:border-arauca-600 transition">Acessar Ficha Técnica</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- DETALHES E MAPA ---
        function openDetails(id) {
            const p = plants.find(pl => pl.id === id);
            if(!p) return;

            // Preencher Textos
            document.getElementById('modalFamily').innerText = p.family;
            document.getElementById('modalTitle').innerText = p.scientificName;
            document.getElementById('modalAuthor').innerText = p.author;
            document.getElementById('modalVoucher').innerText = p.voucher;
            document.getElementById('modalLaymanText').innerText = p.laymanBox;
            document.getElementById('modalDiagnosis').innerText = p.description.diagnosis;
            document.getElementById('modalDescription').innerText = p.description.full;
            document.getElementById('modalEcology').innerText = p.description.ecology;
            
            // Taxonomia
            document.getElementById('modalTaxonomy').innerText = p.taxonomy.chain;
            document.getElementById('modalSynonyms').innerHTML = p.taxonomy.synonyms.map(s=>`<li>${s}</li>`).join('');

            // Imagens
            window.currentPlant = p; // Salva ref global para o swap
            swapImage('field');

            // --- GRÁFICO DE FENOLOGIA (Lit vs Local) ---
            const phenoDiv = document.getElementById('phenologyChart');
            const months = ['J','F','M','A','M','J','J','A','S','O','N','D'];
            let phenoHTML = '<div class="grid grid-cols-12 gap-0.5">';
            
            months.forEach((m, idx) => {
                const isLit = p.phenology.lit_flowering.includes(idx);
                const isLocal = p.phenology.local_collection.includes(idx);
                
                // Barra Superior (Literatura)
                let bgClass = isLit ? 'bg-flower-500 opacity-40' : 'bg-gray-100';
                // Ponto Inferior (Coleta)
                let marker = isLocal ? '<div class="w-1.5 h-1.5 bg-arauca-700 rounded-full mx-auto mt-1 shadow-sm border border-white"></div>' : '<div class="h-2"></div>';

                phenoHTML += `
                    <div class="flex flex-col items-center">
                        <div class="h-8 w-full ${bgClass} rounded-t text-[8px] flex items-end justify-center pb-0.5 text-gray-500">${m}</div>
                        <div class="h-4 w-full bg-gray-50 border-t border-gray-100 flex items-start justify-center rounded-b">
                            ${marker}
                        </div>
                    </div>
                `;
            });
            phenoHTML += '</div>';
            phenoDiv.innerHTML = phenoHTML;

            // Abrir Modal
            const modal = document.getElementById('detailsModal');
            modal.classList.remove('hidden');

            // --- INICIALIZAR MAPA LEAFLET ---
            // Pequeno delay para garantir que o modal abriu (Leaflet buga se container estiver oculto)
            setTimeout(() => {
                if(mapInstance) {
                    mapInstance.remove(); // Limpa mapa anterior
                    mapInstance = null;
                }
                
                // Se tiver coordenadas
                if(p.coords) {
                    mapInstance = L.map('map').setView(p.coords, 10);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap',
                        maxZoom: 18
                    }).addTo(mapInstance);

                    // Marcador Personalizado
                    L.circleMarker(p.coords, {
                        color: '#324e41',
                        fillColor: '#5c8d75',
                        fillOpacity: 0.8,
                        radius: 8
                    }).addTo(mapInstance)
                    .bindPopup(`<b>${p.voucher}</b><br>Coleta: ${p.scientificName}`).openPopup();
                } else {
                    document.getElementById('map').innerHTML = '<p class="text-center pt-10 text-gray-400">Coordenadas não disponíveis</p>';
                }
            }, 300);
        }

        function closeDetails() { document.getElementById('detailsModal').classList.add('hidden'); }

        function swapImage(type) {
            const p = window.currentPlant;
            const img = document.getElementById('modalImage');
            const cap = document.getElementById('modalImgCaption');
            const btnF = document.getElementById('btn-field');
            const btnE = document.getElementById('btn-exsiccate');

            if(type === 'field') {
                img.src = p.images.field.url;
                cap.innerText = p.images.field.caption;
                btnF.className = "flex-1 py-1.5 text-xs font-bold uppercase rounded bg-arauca-100 text-arauca-700 shadow-sm transition";
                btnE.className = "flex-1 py-1.5 text-xs font-bold uppercase rounded text-gray-400 hover:bg-gray-50 transition";
            } else {
                img.src = p.images.exsiccate.url;
                cap.innerText = p.images.exsiccate.caption;
                btnE.className = "flex-1 py-1.5 text-xs font-bold uppercase rounded bg-gray-200 text-gray-700 shadow-sm transition";
                btnF.className = "flex-1 py-1.5 text-xs font-bold uppercase rounded text-gray-400 hover:bg-gray-50 transition";
            }
        }

        // --- LÓGICA DA CHAVE ---
        let keyFilters = {};
        function filterKey(trait, value) {
            if(keyFilters[trait] === value) delete keyFilters[trait];
            else keyFilters[trait] = value;
            
            // Visual Checkboxes Logic
            document.querySelectorAll('.key-checkbox').forEach(cb => {
                const onchange = cb.getAttribute('onchange');
                // Se este checkbox corresponde ao filtro ativo
                if(keyFilters[trait] === value && onchange.includes(value)) cb.checked = true;
                // Se é da mesma categoria mas valor diferente
                else if(onchange.includes(trait) && !onchange.includes(value)) cb.checked = false;
                // Se categoria vazia
                else if(!keyFilters[trait] && onchange.includes(trait)) cb.checked = false;
            });

            renderKey();
        }

        function renderKey() {
            const res = document.getElementById('keyResults');
            res.innerHTML = '';
            
            const matches = generaKey.filter(g => {
                for(let k in keyFilters) {
                    if(!g.traits[k]) return false;
                    if(Array.isArray(g.traits[k])) {
                        if(!g.traits[k].includes(keyFilters[k])) return false;
                    } else {
                        if(g.traits[k] !== keyFilters[k]) return false;
                    }
                }
                return true;
            });

            document.getElementById('keyCount').innerText = matches.length;

            if(matches.length === 0) res.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-4">Nenhum gênero encontrado.</div>';

            matches.forEach(g => {
                const el = document.createElement('div');
                el.className = "bg-white p-3 border-l-4 border-arauca-500 shadow-sm rounded-r";
                el.innerHTML = `<h4 class="font-bold text-arauca-800 italic">${g.genus}</h4>`;
                res.appendChild(el);
            });
        }
        function resetKey() { keyFilters={}; document.querySelectorAll('.key-checkbox').forEach(c=>c.checked=false); renderKey(); }

        // --- ADMINISTRAÇÃO ---
        function openAdmin() {
            const pass = prompt("Senha de Administrador:");
            if(pass === "arauca") document.getElementById('adminModal').classList.remove('hidden'); // Senha simples
            else alert("Acesso negado.");
        }
        function closeAdmin() { document.getElementById('adminModal').classList.add('hidden'); }
        
        function adminSave(e) {
            e.preventDefault();
            const newPlant = {
                id: Date.now(),
                family: document.getElementById('admFamily').value,
                voucher: document.getElementById('admVoucher').value,
                scientificName: document.getElementById('admName').value,
                coords: [parseFloat(document.getElementById('admLat').value), parseFloat(document.getElementById('admLon').value)],
                images: {
                    field: { url: document.getElementById('admImgField').value || "https://placehold.co/400", caption: "Foto de Campo" },
                    exsiccate: { url: document.getElementById('admImgExsic').value || "https://placehold.co/400", caption: "Exsicata" }
                },
                laymanBox: document.getElementById('admLayman').value,
                description: {
                    diagnosis: document.getElementById('admMorph').value,
                    full: "Descrição completa pendente.",
                    ecology: "Ecologia pendente."
                },
                phenology: { lit_flowering: [], local_collection: [new Date().getMonth()] }, // Padrão: mês atual
                taxonomy: { chain: "Taxonomia pendente", synonyms: [] }
            };
            plants.push(newPlant);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
            renderCollection();
            closeAdmin();
            alert("Espécie cadastrada com sucesso!");
        }

        // --- UTILITÁRIOS ---
        function switchTab(t) {
            document.getElementById('view-collection').classList.add('hidden');
            document.getElementById('view-key').classList.add('hidden');
            if(t==='collection') document.getElementById('view-collection').classList.remove('hidden');
            else document.getElementById('view-key').classList.remove('hidden');
        }
        function downloadData() {
            const blob = new Blob([JSON.stringify(plants, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ARAUCA_Backup.json'; a.click();
        }
        function uploadData(input) {
            const r = new FileReader();
            r.onload = e => { plants = JSON.parse(e.target.result); localStorage.setItem(STORAGE_KEY, JSON.stringify(plants)); renderCollection(); };
            r.readAsText(input.files[0]);
        }

        init();
    </script>
</body>
</html>
