<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbário Digital & Chave Interativa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        botany: { 50: '#f2fcf5', 100: '#e1f8e8', 500: '#34b379', 600: '#259261', 700: '#207550', 800: '#1d5d42', 900: '#194c38' }
                    },
                    fontFamily: { serif: ['Merriweather', 'serif'], sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scientific-name { font-family: 'Merriweather', serif; font-style: italic; }
        .checkbox-wrapper input:checked + div { background-color: #e1f8e8; border-color: #34b379; color: #194c38; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-botany-900 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="ph ph-plant text-3xl text-botany-300"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">Flora de Guarapuava</h1>
                    <p class="text-xs text-botany-200">Herbário & Chave Interativa</p>
                </div>
            </div>
            <div class="flex bg-botany-800 rounded-lg p-1">
                <button onclick="switchTab('collection')" id="tab-collection" class="px-4 py-1.5 rounded-md text-sm font-medium transition bg-botany-600 text-white shadow">Coleção</button>
                <button onclick="switchTab('key')" id="tab-key" class="px-4 py-1.5 rounded-md text-sm font-medium transition text-botany-200 hover:text-white">Chave ID</button>
            </div>
        </div>
    </header>

    <main id="view-collection" class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-serif text-gray-800">Minhas Coletas</h2>
            <div class="flex gap-2">
                <button onclick="downloadData()" class="p-2 text-gray-500 hover:text-botany-600" title="Backup"><i class="ph ph-download-simple text-xl"></i></button>
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="uploadData(this)">
                <button onclick="document.getElementById('importFile').click()" class="p-2 text-gray-500 hover:text-botany-600" title="Restaurar"><i class="ph ph-upload-simple text-xl"></i></button>
                <button onclick="toggleModal()" class="bg-botany-600 hover:bg-botany-500 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                    <i class="ph ph-plus-circle text-lg"></i> Nova Planta
                </button>
            </div>
        </div>
        
        <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>

    <main id="view-key" class="hidden flex-grow max-w-7xl mx-auto px-4 py-8 w-full">
        <div class="mb-6">
            <h2 class="text-2xl font-serif text-gray-800 mb-2">Chave Interativa: Melastomataceae</h2>
            <p class="text-sm text-gray-600">Selecione as características observadas para filtrar os gêneros possíveis.</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="w-full lg:w-1/3 space-y-6">
                
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="ph ph-fruit"></i> Tipo de Fruto</h3>
                    <div class="space-y-2">
                        <label class="checkbox-wrapper cursor-pointer block">
                            <input type="checkbox" class="hidden" onchange="filterKey('fruto', 'baga')">
                            <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition">
                                <span class="font-medium">Baga (Carnoso)</span>
                                <p class="text-xs text-gray-500 mt-1">Geralmente globoso, atrai aves.</p>
                            </div>
                        </label>
                        <label class="checkbox-wrapper cursor-pointer block">
                            <input type="checkbox" class="hidden" onchange="filterKey('fruto', 'capsula')">
                            <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition">
                                <span class="font-medium">Cápsula (Seco)</span>
                                <p class="text-xs text-gray-500 mt-1">Abre-se quando maduro.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="ph ph-flower"></i> Estames & Anteras</h3>
                    <div class="space-y-2">
                        <label class="checkbox-wrapper cursor-pointer block">
                            <input type="checkbox" class="hidden" onchange="filterKey('estame', 'rostrado')">
                            <div class="border border-gray-200 rounded-lg p-3 transition">Anteras Rostradas (Bico longo)</div>
                        </label>
                        <label class="checkbox-wrapper cursor-pointer block">
                            <input type="checkbox" class="hidden" onchange="filterKey('estame', 'amarelo')">
                            <div class="border border-gray-200 rounded-lg p-3 transition">Anteras Amarelas</div>
                        </label>
                        <label class="checkbox-wrapper cursor-pointer block">
                            <input type="checkbox" class="hidden" onchange="filterKey('estame', 'conectivo_longo')">
                            <div class="border border-gray-200 rounded-lg p-3 transition">Conectivo Longo/Curvo (Roxo)</div>
                        </label>
                    </div>
                </div>

                 <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="ph ph-star"></i> Pétalas</h3>
                    <div class="space-y-2">
                        <label class="checkbox-wrapper cursor-pointer block">
                            <input type="checkbox" class="hidden" onchange="filterKey('petala', 'aguda')">
                            <div class="border border-gray-200 rounded-lg p-3 transition">Ápice Agudo (Pontiagudo)</div>
                        </label>
                        <label class="checkbox-wrapper cursor-pointer block">
                            <input type="checkbox" class="hidden" onchange="filterKey('petala', 'arredondada')">
                            <div class="border border-gray-200 rounded-lg p-3 transition">Ápice Arredondado/Truncado</div>
                        </label>
                    </div>
                </div>
                
                <button onclick="resetKey()" class="w-full py-2 text-sm text-gray-500 underline hover:text-botany-600">Limpar Filtros</button>
            </div>

            <div class="w-full lg:w-2/3">
                <div class="mb-4 text-sm font-medium text-gray-500">
                    Gêneros compatíveis: <span id="keyCount" class="text-botany-700 font-bold text-lg">0</span>
                </div>
                <div id="keyResults" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-botany-800 px-6 py-4 flex justify-between items-center text-white">
                <h2 class="font-semibold">Nova Espécie</h2>
                <button onclick="toggleModal()"><i class="ph ph-x text-2xl"></i></button>
            </div>
            <form id="plantForm" onsubmit="addPlant(event)" class="p-6 space-y-4">
                <select id="inputFamily" required class="w-full border p-2 rounded"><option value="Melastomataceae">Melastomataceae</option><option value="Solanaceae">Solanaceae</option><option value="Rubiaceae">Rubiaceae</option></select>
                <input type="text" id="inputSpecies" placeholder="Espécie (ex: Miconia sp.)" required class="w-full border p-2 rounded italic">
                <textarea id="inputDiagnostics" placeholder="Diagnóstico" required class="w-full border p-2 rounded"></textarea>
                <textarea id="inputNotes" placeholder="Notas" class="w-full border p-2 rounded"></textarea>
                <button type="submit" class="w-full bg-botany-600 text-white py-2 rounded hover:bg-botany-700">Salvar</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. DADOS DA COLEÇÃO (Seu Herbário) ---
        const seedData = [
            { id: 1, family: "Melastomataceae", species: "Rhynchanthera sp.", diagnostics: "Fruto cápsula. Anteras rostradas.", notes: "Banhados." },
            { id: 2, family: "Melastomataceae", species: "Miconia sp.", diagnostics: "Fruto baga. Pétalas arredondadas.", notes: "Mata." }
        ];
        let plants = [];
        const STORAGE_KEY = 'herbario_v2';

        // --- 2. DADOS DA CHAVE (Base de Conhecimento Taxonômico) ---
        // Aqui configuramos a lógica "Se tem isso, é aquilo"
        const generaDatabase = [
            { 
                genus: "Miconia", 
                traits: { fruto: "baga", petala: "arredondada" }, 
                desc: "Arbustos ou árvores. Inflorescência terminal. Um dos gêneros mais comuns." 
            },
            { 
                genus: "Leandra", 
                traits: { fruto: "baga", petala: "aguda" }, 
                desc: "Distingue-se de Miconia pelas pétalas agudas e indumento (pelos) geralmente denso." 
            },
            { 
                genus: "Pleroma (Tibouchina)", 
                traits: { fruto: "capsula", estame: "conectivo_longo" }, 
                desc: "Flores vistosas (roxas/lilases). Estames com conectivo prolongado e curvo." 
            },
            { 
                genus: "Chaetogastra", 
                traits: { fruto: "capsula", estame: "amarelo" }, 
                desc: "Semelhante a Pleroma, mas com anteras amarelas e conectivo curto." 
            },
            { 
                genus: "Rhynchanthera", 
                traits: { fruto: "capsula", estame: "rostrado" }, 
                desc: "Anteras com bico longo (rostradas). Comum em áreas úmidas." 
            },
            { 
                genus: "Acisanthera", 
                traits: { fruto: "capsula" }, 
                desc: "Pequeno porte (ervas/subarbustos). Ovário glabro." 
            }
        ];
        
        let activeFilters = {};

        // --- 3. INICIALIZAÇÃO ---
        function init() {
            // Carregar Coleção
            const stored = localStorage.getItem(STORAGE_KEY);
            plants = stored ? JSON.parse(stored) : seedData;
            renderCollection();
            
            // Carregar Chave (sem filtros iniciais)
            renderKey();
        }

        // --- 4. FUNÇÕES DE NAVEGAÇÃO ---
        function switchTab(tab) {
            document.getElementById('view-collection').classList.add('hidden');
            document.getElementById('view-key').classList.add('hidden');
            document.getElementById('tab-collection').className = "px-4 py-1.5 rounded-md text-sm font-medium transition text-botany-200 hover:text-white";
            document.getElementById('tab-key').className = "px-4 py-1.5 rounded-md text-sm font-medium transition text-botany-200 hover:text-white";

            if(tab === 'collection') {
                document.getElementById('view-collection').classList.remove('hidden');
                document.getElementById('tab-collection').className = "px-4 py-1.5 rounded-md text-sm font-medium transition bg-botany-600 text-white shadow";
            } else {
                document.getElementById('view-key').classList.remove('hidden');
                document.getElementById('tab-key').className = "px-4 py-1.5 rounded-md text-sm font-medium transition bg-botany-600 text-white shadow";
            }
        }

        // --- 5. LÓGICA DA CHAVE INTERATIVA ---
        function filterKey(category, value) {
            // Se já estiver marcado, desmarca (toggle)
            if (activeFilters[category] === value) {
                delete activeFilters[category];
                // Desmarca visualmente os inputs desse grupo
                const inputs = document.querySelectorAll(`input[onchange="filterKey('${category}', '${value}')"]`);
                inputs.forEach(i => i.checked = false);
            } else {
                // Marca o novo e substitui anterior da mesma categoria
                activeFilters[category] = value;
                 // (O comportamento do radio button seria automático, mas checkbox permite flexibilidade futura)
                // Aqui simplificamos: 1 opção por categoria por enquanto
                const inputs = document.querySelectorAll(`input[onchange^="filterKey('${category}')"]`);
                inputs.forEach(i => {
                    if(!i.getAttribute('onchange').includes(`'${value}'`)) i.checked = false;
                });
            }
            renderKey();
        }

        function resetKey() {
            activeFilters = {};
            document.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
            renderKey();
        }

        function renderKey() {
            const container = document.getElementById('keyResults');
            const countDisplay = document.getElementById('keyCount');
            container.innerHTML = '';

            // Filtragem
            const matches = generaDatabase.filter(genus => {
                for (const [key, value] of Object.entries(activeFilters)) {
                    // Se o gênero tem a info definida, tem que bater. Se não tiver info, não eliminamos (permissivo)
                    if (genus.traits[key] && genus.traits[key] !== value) {
                        return false;
                    }
                }
                return true;
            });

            countDisplay.innerText = matches.length;

            if(matches.length === 0) {
                container.innerHTML = `<div class="col-span-2 text-center py-10 text-gray-500">Nenhum gênero corresponde a essa combinação. Tente desmarcar alguma opção.</div>`;
                return;
            }

            matches.forEach(g => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg border-l-4 border-botany-500 shadow-sm flex flex-col justify-between";
                card.innerHTML = `
                    <div>
                        <h3 class="scientific-name text-lg font-bold text-botany-900">${g.genus}</h3>
                        <p class="text-sm text-gray-600 mt-1">${g.desc}</p>
                    </div>
                    <div class="mt-3 flex gap-2 text-xs">
                        ${g.traits.fruto ? `<span class="bg-gray-100 px-2 py-1 rounded border border-gray-200">Fruto: ${g.traits.fruto}</span>` : ''}
                        ${g.traits.estame ? `<span class="bg-gray-100 px-2 py-1 rounded border border-gray-200">Estame: ${g.traits.estame}</span>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 6. FUNÇÕES DA COLEÇÃO (CRUD) ---
        function renderCollection() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            plants.forEach(plant => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative";
                card.innerHTML = `
                    <span class="text-xs font-bold text-botany-600 uppercase bg-botany-50 px-2 py-1 rounded mb-2 inline-block">${plant.family}</span>
                    <h3 class="scientific-name text-xl text-gray-800">${plant.species}</h3>
                    <p class="text-sm text-gray-600 mt-2 border-l-2 border-botany-200 pl-3 italic">${plant.diagnostics}</p>
                    <p class="text-xs text-gray-400 mt-3">${plant.notes}</p>
                    <button onclick="deletePlant(${plant.id})" class="absolute top-4 right-4 text-gray-300 hover:text-red-500"><i class="ph ph-trash"></i></button>
                `;
                grid.appendChild(card);
            });
        }

        function addPlant(e) {
            e.preventDefault();
            const newPlant = {
                id: Date.now(),
                family: document.getElementById('inputFamily').value,
                species: document.getElementById('inputSpecies').value,
                diagnostics: document.getElementById('inputDiagnostics').value,
                notes: document.getElementById('inputNotes').value
            };
            plants.push(newPlant);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
            renderCollection();
            toggleModal();
            document.getElementById('plantForm').reset();
        }

        function deletePlant(id) {
            if(confirm('Apagar esta planta?')) {
                plants = plants.filter(p => p.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
                renderCollection();
            }
        }

        function toggleModal() {
            const m = document.getElementById('modalOverlay');
            m.classList.toggle('hidden');
        }
        
        // Backup
        function downloadData() {
            const blob = new Blob([JSON.stringify(plants, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `herbario_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }
        function uploadData(input) {
            const reader = new FileReader();
            reader.onload = e => { 
                plants = JSON.parse(e.target.result); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
                renderCollection();
            };
            reader.readAsText(input.files[0]);
        }

        init();
    </script>
</body>
</html>
